rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for the 'users' collection
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null &&
                      exists(/databases/$(database)/documents/business_info/$(request.auth.uid));
    }

    // Rule for 'business_info' collection
    match /business_info/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }
    // Rule for the 'itemGroups' collection
    match /itemGroups/{itemGroupId} {
      allow read, write: if request.auth != null;
    }

    // Rule for the 'items' collection
    match /items/{itemId} {
      allow read, write: if request.auth != null;
    }

    // Rule for 'sales' collection
    match /sales/{saleId} {
      allow read, update, delete: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Rule for 'salesReturns' collection
    match /salesReturns/{returnId} {
        allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Rule for 'purchases' collection
    match /purchases/{purchaseId} {
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // *** FIX: Added new rule for 'purchaseReturns' collection ***
    match /purchaseReturns/{returnId} {
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // This rule is for a different data structure and can be kept if needed
    match /artifacts/{appId}/users/{userId}/{collectionId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /permissions/{role} {
      // Allows any signed-in user to read the permission documents.
      allow read: if request.auth != null;
      
      // Explicitly denies any client-side writes to prevent tampering.
      allow write,update,delete : if request.auth != null;
    }
  }
}